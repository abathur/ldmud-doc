<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Tsunami: mysql</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tsunami
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('driver_concepts_mysql.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">mysql </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>On hosts with the mySQL package installed, the driver can be configured to interface with the mySQL database. If that is done, the driver defines the macro <b>MYSQL</b> for LPC programs and activates a number of efuns.</p>
<h2>CONFIGURATION</h2>
<p>Create a dedicated user in the mySQL database for the driver. Enter this username and password in the file pkg-mysql.c, function mysql_real_connect(), and compile the driver (the username and password are built into the driver for security reasons). If you choose to not create either a username and/or a password, leave the corresponding entry at 0.</p>
<p>Use mysqladmin to create any databases you want to provide - the names are later used in the efun db_connect() to connect to the databases.</p>
<h2>USAGE</h2>
<p>The idea behind SQL-support is that you can swap large amounts of data into a database where it can be accessed very easily. As mySQL "limits" the number of connections to 100 and as every connection to the mySQL-server takes time, you should use database serverobjects in your MUD which constantly keep the connection to the mySQL-server.</p>
<p>To connect to your mySQL-server, use the efun db_connect(). It takes only one argument which is the name of the database (which must exist). The return-value of db_connect() is an integer representing the unique handle to the database with which you will identify your connection later.</p>
<p>To send or retrieve data from this connection, use db_exec(). The first parameter for all efuns dealing with an open connection is always the handle and so is the first argument the handle and the second one the command you want to issue. The return-value is either 0 if there was an error in your command (this can have various reasons), otherwise your handle is returned again. A typical SQL-statement to retrieve data would be like this:</p>
<div class="fragment"><div class="line">select aliases.command from aliases where (name = <span class="stringliteral">&#39;mario&#39;</span> AND</div>
<div class="line">  alias regexp <span class="stringliteral">&#39;l.*&#39;</span>)</div>
</div><!-- fragment --><p> As you know, mySQL accepts either " or ' to classify strings for parameters. Most likely, you will pass variables and don't know whether they contain one or more of these key-chars (or even other chars that need to be converted). mySQL provides a function for converting just any string into an acceptable argument and this is implemented in db_conv_string().</p>
<p>So the above example with variables looks like this:</p>
<div class="fragment"><div class="line">select aliases.command from aliases where (name =<span class="stringliteral">&#39;&quot;+</span></div>
<div class="line"><span class="stringliteral">  db_conv_string(name)+&quot;&#39;</span> AND alias regexp <span class="stringliteral">&#39;&quot;+</span></div>
<div class="line"><span class="stringliteral">  db_conv_string(mask)+&quot;&#39;</span>)</div>
</div><!-- fragment --><p> I left out the db_exec()-stuff, more complete examples will follow.</p>
<p>After you initiated a statement that should return rows from the database, use db_fetch() to retrieve the data. db_fetch() returns the data row by row and not all at once. You need to call it until it returns 0. THIS IS IMPORTANT! If stop calling db_fetch() before it reaches the end of data, serious inconsistencies can happen.</p>
<p>If you used a DELETE- or UPDATE-statement, you cannot call db_fetch(), but you might be interested in the number of deleted/changed rows which can be queried with db_affected_rows().</p>
<p>After all operations are done in the database, you should use db_close() to close the connection again. If you are using a database-server-concept, place it in the remove()-function.</p>
<p>The SQL-efuns have some built-in optimization-features to speed up often used connections. To get a list of all open connections to the mySQL-server, use db_handles() which returns an array of integers with all open handles.</p>
<h2>SECURITY</h2>
<p>Most SQL efuns (unless execute by the master or the simul-efun object) trigger a privilege_violation ("mysql", "&lt;efun_name&gt;"). If a more finegrained control is desired, overload the individual efuns with a nomask simul-efun.</p>
<p>The unprivileged efuns are:</p>
<ul>
<li><a class="el" href="classefun.html#a5cbfc312aa2e18ee6693c8a2b38c5aaa" title="Convert the string &lt;str&gt; into a string that is correctly interpretated for usage as a string in db_ex...">efun::db_conv_string()</a></li>
</ul>
<dl class="section user"><dt>warning:The driver enables automatic reconnects on the database connections. This means that if a connection is lost&ndash;the most common case for this is timeouts, which by default happen after 28800 seconds of inactivity&ndash;an attempt will be made to establish a new connection to the database server. When that happens, all session state (temprary tables and state changes from SET statements) will be lost. It's best not to rely on such state.</dt><dd></dd></dl>
<h2>EXAMPLE</h2>
<p>A simple server to store aliases could be implemented like this:</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">**  CREATION:</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">**  create table aliases (</span></div>
<div class="line"><span class="comment">**      name varchar(15) not NULL,</span></div>
<div class="line"><span class="comment">**      alias varchar(20) not NULL,</span></div>
<div class="line"><span class="comment">**      command varchar(255) not NULL,</span></div>
<div class="line"><span class="comment">**      primary key (name, alias));</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">#define DATABASE &quot;mud&quot;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">private int handle;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">public void create()</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  handle = db_connect(DATABASE);</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">public int remove()</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  if ( handle )</span></div>
<div class="line"><span class="comment">    db_close(handle);</span></div>
<div class="line"><span class="comment">  destruct(ME);</span></div>
<div class="line"><span class="comment">  return !ME;</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">public int AddAlias(string alias, string command, object ob)</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  if ( !handle )</span></div>
<div class="line"><span class="comment">    handle = db_connect(DATABASE);</span></div>
<div class="line"><span class="comment">  if ( !db_exec(handle, &quot;insert into aliases (name, alias, command) values (&#39;&quot; + getuid(ob) + &quot;&#39;,&#39;&quot; + db_conv_string(alias)+ &quot;&#39;,&#39;&quot; +db_conv_string(command) + &quot;&#39;)&quot;) )</span></div>
<div class="line"><span class="comment">    return -1;</span></div>
<div class="line"><span class="comment">  return 1;</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">public int RemoveAlias(string alias, object ob)</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  int res;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  if ( !handle )</span></div>
<div class="line"><span class="comment">    handle = db_connect(DATABASE);</span></div>
<div class="line"><span class="comment">  res = db_exec(handle,</span></div>
<div class="line"><span class="comment">    &quot;delete from aliases where (name = &#39;&quot;+ getuid(ob) + &quot;&#39; AND alias = &#39;&quot; + db_conv_string(alias)+ &quot;&#39;)&quot;);</span></div>
<div class="line"><span class="comment">  if ( !res )</span></div>
<div class="line"><span class="comment">    return 0;</span></div>
<div class="line"><span class="comment">  res = db_affected_rows(handle);</span></div>
<div class="line"><span class="comment">  return (res &gt; 0)?1:-1;</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">public mixed *QueryAliases(string mask, object ob)</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  mixed *result;</span></div>
<div class="line"><span class="comment">  string *tmp;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  if ( !handle )</span></div>
<div class="line"><span class="comment">    handle = db_connect(DATABASE);</span></div>
<div class="line"><span class="comment">  if ( !db_exec(handle, &quot;select aliases.alias, aliases.command from aliases where (name = &#39;&quot; + getuid(ob) + &quot;&#39; AND alias regexp &#39;&quot; + db_conv_string(mask) + &quot;&#39;)&quot;) )</span></div>
<div class="line"><span class="comment">    return ({ });</span></div>
<div class="line"><span class="comment">  result = ({ });</span></div>
<div class="line"><span class="comment">  while ( sizeof(tmp = db_fetch(handle)) )</span></div>
<div class="line"><span class="comment">    result += ({ tmp });</span></div>
<div class="line"><span class="comment">  return result;</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">public string QueryAlias(string alias, object ob)</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  mixed *result;</span></div>
<div class="line"><span class="comment">  string *tmp;</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  if ( !handle )</span></div>
<div class="line"><span class="comment">    handle = db_connect(DATABASE);</span></div>
<div class="line"><span class="comment">  if ( !db_exec(handle, &quot;select aliases.command from aliases where (name = &#39;&quot; + getuid(ob)+ &quot;&#39; AND alias = &#39;&quot; + db_conv_string(alias) + &quot;&#39;)&quot;) )</span></div>
<div class="line"><span class="comment">    return 0;</span></div>
<div class="line"><span class="comment">  result = ({ });</span></div>
<div class="line"><span class="comment">  while ( sizeof(tmp = db_fetch(handle)) )</span></div>
<div class="line"><span class="comment">    result += tmp;</span></div>
<div class="line"><span class="comment">  return sizeof(result)?result[0]:0;</span></div>
<div class="line"><span class="comment">}</span></div>
</div><!-- fragment --><p>AUTHOR:</p>
<div class="fragment"><div class="line">Mark Daniel Reidel and others.</div>
</div><!-- fragment --><dl class="section user"><dt>History:</dt><dd><div class="fragment"><div class="line">introduced (3.2.8) -- as <span class="keyword">package</span></div>
<div class="line"><span class="keyword"></span>changed (3.2.9) -- integrated with driver</div>
<div class="line">changed (3.2.11) -- added a privilege_violation() call for each efun</div>
</div><!-- fragment --></dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="driver_concepts_pgsql.html">pgsql</a>, <a class="el" href="classefun.html#a189f629b6f5461a8a6637c4fae69e7e4">efun::db_affected_rows()</a>, <a class="el" href="classefun.html#a5cbfc312aa2e18ee6693c8a2b38c5aaa" title="Convert the string &lt;str&gt; into a string that is correctly interpretated for usage as a string in db_ex...">efun::db_conv_string()</a>, <a class="el" href="classefun.html#a5286f8999424c84309cbed60dde101f4">efun::db_close()</a>, <a class="el" href="classefun.html#a812dfa6948546b8539038f6924944435">efun::db_connect()</a>, <a class="el" href="classefun.html#ae4a665bd9b3fd1bbfd527d3b1e827763">efun::db_exec()</a>, <a class="el" href="classefun.html#a99208794ce39f11037cd4ca56c30ade5">efun::db_fetch()</a>, <a class="el" href="classefun.html#a1fdefa3fca7e507606cf45baf38b0cbf">efun::db_handles()</a>, <a class="el" href="classefun.html#a6dd2821ef141bd777f88608514e23f37">efun::db_insert_id()</a>, <a class="el" href="classefun.html#a5e7193b4798e703cbd1b39050711b6d3">efun::db_coldefs()</a>, <a class="el" href="classefun.html#acd85d4e031c2a63ae341b96ba9a71053">efun::db_error()</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="driver_todo.html">todo</a></li>
    <li class="footer">Generated on Sat Jun 11 2016 14:24:11 for Tsunami by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
