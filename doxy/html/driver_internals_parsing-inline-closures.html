<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Tsunami: parsing-inline-closures</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tsunami
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('driver_internals_parsing-inline-closures.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">parsing-inline-closures </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This short document tries to outline how scopes and variables are handled when parsing inline closures.</p>
<p>Let's take the following closure as an example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> var;</div>
<div class="line"></div>
<div class="line"><span class="keyword">function</span> void(<span class="keywordtype">string</span> arg) : int ctx = 42</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i = 2;</div>
<div class="line"></div>
<div class="line">    ctx += var - i;</div>
<div class="line">};</div>
</div><!-- fragment --><p> This closure might be a part of a code block, an initializer of a global variable or an initializer of a context variable of another closure.</p>
<p>The example above has 4 block scopes in this order:</p>
<ol type="1">
<li>The outer block scope with 'var'.</li>
<li>The context scope with 'ctx'.</li>
<li>The argument scope with 'arg'.</li>
<li>The inner block scope with 'i'.</li>
</ol>
<p>In each scope there may be three kinds of local variables (each one of them has .type = I_TYPE_LOCAL):</p>
<ul>
<li>real local ones: .u.local.context &lt; 0</li>
<li>explicit context variables: .u.local.context &gt;= 0 and .u.local.num &lt; 0</li>
<li>implicit context variables: .u.local.context &gt;= 0 and .u.local.num &gt;= 0</li>
</ul>
<p>Each local variable will have an index on the stack relative to the stack frame of the function or inline closure, and each context variable will have an index into the closure's context. So the variable counters will be reset in block 2 (context scope), because then the closure (with it's own stack frame) will start. The block 2 (context) is first compiled as a part of the outer function and will then be transferred to the closure.</p>
<p>The above example will introduce the following variables:</p>
<p>Outer function:</p>
<ul>
<li>'var': A local variable in scope 1, index 0</li>
<li>'ctx': A local variable in scope 2, index 1</li>
</ul>
<p>Inline closure:</p>
<ul>
<li>'arg': A local variable in scope 3, index 0</li>
<li>'i': A local variable in scope 4, index 1</li>
<li>'ctx': An explicit context variable in scope 2, context index 0</li>
<li>'var': An implicit context variable in scope 2, context index 1, variable index 1.</li>
</ul>
<p>The inline closure is parsed in 4 steps:</p>
<ol type="1">
<li>After <code>function void</code> the inline closure information structure (inline_closure_t) is initialized. For each inline closure that was parsed within a normal function such a structure is put into the A_INLINE_CLOSURE memory area. When the normal function is finished, the program code of all these closures will be copied from these structures into the real program's code block. Also, the context scope and the argument scope are initialized. The argument scope is the inner scope, because they are parsed next. The variable counter (current_number_of_locals) is reset to 0 (but the old value is saved in the scope structure).</li>
<li>Then (string arg) will be parsed, the same as for normal functions. The variable names will be put into the innermost scope as local names.</li>
<li><p class="startli">The context <code>: int ctx = 42</code> will be parsed. The context arguments will be parsed as if they would belong to the outer scope. In fact, the compiler will issue bytecode to initialize them as local variables of the outer function and store their values there. The F_CONTEXT_CLOSURE bytecode will later copy these variables from this function into the closure as its context. In order for this to happen, scope 2 is initialized as it would belong to the outer function (its variable counter <code>first_local</code> is set to the counter of scope 1). Scope 3 will be ignored and marked inaccessible so that references to argument names are caught as errors. Then the context is parsed and the variables are not put into the topmost scope 3, but the one underneath it (scope 2).</p>
<p class="startli">In the end, each variable in scope 2 is given a context index and stripped of its variable index, so that they become explicit context variables.</p>
</li>
<li>The block will be parsed. That's done just like a normal function except that, wherever a local variable is used, the compiler calls check_for_context_local to see whether this variable belongs to an outer scope (block depth of the variable is below the initial block depth of the inline closure). If that is the case the compiler introduces a new context variable with the same name but in the context scope 2 of the inline variable. The index of the original variable is recorded in the .u.local.num field (it the original variable is also a context variable, CONTEXT_VARIABLE_BASE is added to its context index). After the block has been compiled, its bytecode will be moved into the A_INLINE_CLOSURE memory block (together with the line-number information). It will be copied back after the current function has been completed. Also, a bytecode is issued for each implicit variable to put the value from the original variable on the stack. These values will serve as arguments for the final F_CONTEXT_CLOSURE bytecode. </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="driver_todo.html">todo</a></li>
    <li class="footer">Generated on Tue Jun 7 2016 19:15:59 for Tsunami by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
