<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Tsunami: concepts/negotiation.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tsunami
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('negotiation_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">concepts/negotiation.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;negotiation {#driver_concepts_negotiation}</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;==========================================</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;The telnet protocol is used to control textbased connections between a client (the <span class="stringliteral">&#39;telnet&#39;</span> program or a mud client) and a server (the game driver). Most of the options offered by the protocol are optional and need to be negotiated between the client and the server. Consequently, and due to their specialized nature, mud clients don<span class="stringliteral">&#39;t have to support the full telnet option feature set.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral">For the server to find out if a client supports the telnet protocol at all, one good approach is to issue a simple, commonly used telnet command to the client. If the client reaction conforms to the protocol (or sends telnet commands itself), the mud can continue to negotiate further options. If the client does not react, the mud can safely refrain from further negotiations.</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="stringliteral">The following list is a more or less comprehensive overview of the telnet related RFCs (available for example on @subpage driver_http:__www.faqs.org_rfcs &quot;http://www.faqs.org/rfcs&quot;):</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="stringliteral">~~~{.c}</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="stringliteral">RFC Title                                              rel. Code</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="stringliteral">495 TELNET Protocol Specification</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="stringliteral">513 Comments on the new TELNET specifications</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="stringliteral">559 Comments on the new TELNET Protocol and its Implem</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="stringliteral">595 Some Thoughts in Defense of the TELNET Go-Ahead</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="stringliteral">596 Second Thoughts on Telnet Go-Ahead</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="stringliteral">652 Telnet Output Carriage-Return Disposition Option   NAOCRD     10</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="stringliteral">653 Telnet Output Horizontal Tabstops Option           NAOHTS     11</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="stringliteral">654 Telnet Output Horizontal Tab Disposition Option    NAOHTD     12</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="stringliteral">655 Telnet Output Formfeed Disposition Option          NAOFFD     13</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="stringliteral">656 Telnet Output Vertical Tabstops Option             NAOVTS     14</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="stringliteral">657 Telnet Output Vertical Tab Disposition Option      NAOVTD     15</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="stringliteral">658 Telnet Output Linefeed Disposition                 NAOLFD     16</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="stringliteral">698 Telnet Extended Ascii Option                       X-ASCII    17</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="stringliteral">727 Telnet Logout Option                               LOGOUT     18</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="stringliteral">728 A Minor Pitfall in the Telnet Protocol</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="stringliteral">735 Revised TELNET Byte Macro Option                   BM         19</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="stringliteral">749 Telnet SUPDUP-OUTPUT Option                        SUPDUP     22</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="stringliteral">764 Telnet Protocol Specification</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="stringliteral">779 Telnet SEND-LOCATION Option                        SENDLOC    23</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="stringliteral">818 The Remote User Telnet Service</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="stringliteral">854 Telnet Protocol Specification</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="stringliteral">855 Telnet Option Specifications</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="stringliteral">856 Telnet Binary Transmission                         BINARY      0</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="stringliteral">857 Telnet Echo Option                                 ECHO        1</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="stringliteral">858 Telnet Suppress Go Ahead Option                    SGA         3</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="stringliteral">859 Telnet Status Option                               STATUS      5</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="stringliteral">860 Telnet Timing Mark Option                          TM          6</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="stringliteral">861 Telnet Extended Options - List Option              EXOPL     255</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="stringliteral">884 Telnet Terminal Type Option                        TTYPE      24</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="stringliteral">885 Telnet End of Record Option                        EOR        25</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="stringliteral">930 Telnet Terminal Type Option                        TTYPE      24</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="stringliteral">933 Output Marking Telnet Option                       OUTMRK     27</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="stringliteral">946 Telnet Terminal Location Number Option             TTYLOC     28</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="stringliteral">1043 Telnet Data Entry Terminal Option DODIIS Implement DET        20</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="stringliteral">1053 Telnet X.3 PAD Option                              X.3-PAD    30</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="stringliteral">1073 Telnet Window Size Option                          NAWS       31</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="stringliteral">1079 Telnet Terminal Speed Option                       TSPEED     32</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="stringliteral">1080 Telnet Remote Flow Control Option                  FLOWCTRL   33</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="stringliteral">1091 Telnet Terminal-Type Option                        TTYPE      24</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="stringliteral">1096 Telnet X Display Location Option                   XDISPLOC   35</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="stringliteral">1116 Telnet Linemode Option                             LINEMODE   34</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="stringliteral">1143 The Q Method of Implementing TELNET Option Negotia</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="stringliteral">1184 Telnet Linemode Option                             LINEMODE   34</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="stringliteral">1372 Telnet Remote Flow Control Option                  FLOWCTRL   33</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="stringliteral">1408 Telnet Environment Option                          ENVIRON    36</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="stringliteral">1571 Telnet Environment Option Interoperability Issues</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="stringliteral">1572 Telnet Environment Option                          NEWENV     39</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="stringliteral">2066 Telnet Charset Option                              CHARSET    42</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="stringliteral">2217 Telnet Com Port Control Option                     COMPORT    44</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="stringliteral">2877 5250 Telnet Enhancements</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="stringliteral">~~~</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="stringliteral">All negotiations start with the special character IAC which is defined in /usr/include/arpa/telnet.h (or in src/driver/telnet.h for 3.2(.1)) and has the decimal value of 255. Negotiations are based on different telnetoptions (their values are defined in telnet.h too). Before a negotiation can start the client and the server have to agree that they support the option. This works in the following way:</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="stringliteral">If a client wants to send something to the server it has to send &#39;</span>IAC WILL option<span class="stringliteral">&#39; (For terminaltype negotation this would be the 3 bytes 255,251,24; again, check telnet.h) to confirm that it is able to do that. If the server is supporting that option and wants to receive something it sends &#39;</span>IAC DO option<span class="stringliteral">&#39; (255,253,option)</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="stringliteral">If one side is receiving an &#39;</span>IAC WILL option<span class="stringliteral">&#39; and has not yet sent with DO or DONT it has to respond with either &#39;</span>IAC DO option<span class="stringliteral">&#39; if it will support this negotiation or &#39;</span>IAC DONT option<span class="stringliteral">&#39; if it won&#39;</span>t.</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;If one side is receiving an <span class="stringliteral">&#39;IAC DO option&#39;</span> and has not yet sent a WILL or WONT it has to reply with either <span class="stringliteral">&#39;IAC WILL option&#39;</span> <span class="keywordflow">if</span> it supports the option or <span class="stringliteral">&#39;IAC WONT option&#39;</span> <span class="keywordflow">if</span> not.</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;A small example: Lets assume we want to negotiate terminaltype. (TELOPT_TTYPE with value 24). client is the telnet executable on the playerside, the server is the gamedriver.</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;   client                        server</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;   </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;IAC WILL TTYPE</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;   IAC DO TTYPE</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;   </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;Or:</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;   IAC DO TTYPE</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;   </div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;IAC WILL TTYPE</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;After <span class="keyword">this</span> we are ready to transfer the terminaltype from the client to the server as explained below.</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;3 options I have currently implemented.</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;the client and the server have exchanged WILL/DO.</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;terminaltypes from the beginning.</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;Example: (we have exchanged WILL/DO already)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;client                                server</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;   IAC SB TTYPE SEND IAC SE</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;   </div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;IAC SB TTYPE IS VT200 IAC SE</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;IAC SB TTYPE SEND IAC SE</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;IAC SB TTYPE IS VT100 IAC SE</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;IAC SB TTYPE SEND IAC SE</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;IAC SB TTYPE IS VT52 IAC SE</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;IAC SB TTYPE SEND IAC SE</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;IAC SB TTYPE IS VT52 IAC SE</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">/* this marks that we have all terminaltypes. We decide to use the</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment">- vt200 mode so we have to skip to VT200</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">&gt;&gt;*&lt;&lt;/</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">   IAC SB TTYPE SEND IAC SE</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">   </span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">IAC SB TTYPE IS VT200 IAC SE</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">Next important option is NAWS (31) or WindowSizeNegotiation.</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">This one is a bit easier than terminaltype. After having received a IAC DO NAWS from the server, the client will reply with IAC WILL NAWS and immediately after that send IAC SB NAWS columns_high columns_low lines_high lines_low IAC SE where xx_low refers to the lowbyte of xx and xx_high refers to the highbyte of xx. This will be automagically resent at every windowresize (when the client gets a SIGWINCH for example) or at your request with &#39;IAC SB NAWS SEND IAC SE&#39;.</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">Example: (WILL/DO exchanged)</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">client                                server</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">IAC SB NAWS 0 80 0 24 IAC SE         /* the standard vt100 windowsize &gt;&gt;*&lt;&lt;/</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">/* no reply &gt;&gt;*&lt;&lt;/</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">And, a bit less important but most complex, the LINEMODE (34) option. It was implemented it due to the fact, that some weird DOS telnets would not work otherwise. Implemented are only the absolute basic feature, which is the actual switching the telnet to linemode. After exchanging WILL/DO the server sends a modechange request to the client using IAC SB LINEMODE LM_MODE MODE_EDIT IAC SE, which should turn on local commandline-editing for the client. If a client supports LINEMODE it HAS to support this modechange. The client will reply with IAC SB LINEMODE LM_MODE MODE_EDIT|MODE_ACK IAC SE (x|y is bitwise or). That&#39;s it for linemode. (You will perhaps receive other IAC SB LINEMODEs with other LM_xxx ... you may ignore them. (At least IRIX 5.x sends IAC SB LINEMODE LM_SLC .... IAC SE which declares the local characterset.)).</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">Example: (WILL/DO negotiated)</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">client                                        server</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">   IAC SB LINEMODE LM_MODE</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">      MODE_EDIT IAC SE</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">      </span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">IAC SB LINEMODE LM_MODE</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">MODE_EDIT|MODE_ACK IAC SE</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">@par note:The option is more interesting than it looks here. For example it supports a mixed mode between linemode and charactermode, flushing the input at certain characters (at ESC or TAB for shell-like commandline completition). We suggest reading RFC 1184.</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">You might be interested in TELOPT_XDISPLAYLOC and TELOPT_ENVIRON too.</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">Now, how to implement this using LDMud?</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">- Patch src/driver/comm1.c, function init_telopts() to include</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">  telopts_do[TELOPT_XXX] = reply_h_telnet_neg;</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">  telopts_dont[TELOPT_XXX] = reply_h_telnet_neg;</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">  telopts_will[TELOPT_XXX] = reply_h_telnet_neg;</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">  telopts_wont[TELOPT_XXX] = reply_h_telnet_neg;</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">for every telnet negotiation you want to use. Do not overwrite the TELOPT_ECHO and TELOPT_SGA hooks.Alternatively, set the driver hook H_NOECHO in master.c: this diverts _all_ telnet data into the mudlib.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">- Add a new driver hook to master.c just below the others.</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">  set_driver_hook(H_TELNET_NEG,&quot;telnet_neg&quot;),</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">- Make a telnet.h for your mudlib... just change the arrays in</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">  src/driver/telnet.h.</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">- define a function</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">  void telnet_neg(int cmd, int option, int * optargs)</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">in your interactive objects (login.c, shells, player.c or whereever). And note, in ALL objects, through which a player is handed through (in TAPPMud these are login.c and player.c). [Ok, master.c is interactive for a very short time too, but it won&#39;t accept input, will it?] &#39;cmd&#39; will be TELCMD_xxxx (see telnet.h), &#39;option&#39; one of TELOPT_xxxx and &#39;optargs&#39; will be an array of ints (bytes in fact) when &#39;cmd&#39; is SB. Parse &#39;cmd&#39;/&#39;option&#39; and reply with appropiate answers using binary_message() (appropiate meaning sending the right DO/DONT/WILL/WONT if not sent before and using the SB return values).</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">3.1. Send IAC DO TTYPE IAC DO NAWS IAC DO LINEMODE at the</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">first time you can do it (before cat()ing /WELCOME perhaps).</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">3.2. Note all sent and received WILL/WONT/DO/DONT options for</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment">conforming to the standard, avoiding endless loops and for</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">easy debugging :)</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">3.3. Pass those recevied/sent data and other data when the</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">interactive object is changed (from login.c to player.c or</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">at other bodychanges). Clear the data when the player goes</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">linkdead or quits. You won&#39;t need to save this data.</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">3.4. Lower_case() terminaltypes... ;)</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">3.5. Use reasonable defaultvalues if the client does not</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">support one of the options. (columns 80, lines 24 if not</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">NAWS, unknown or vt100 for no terminaltype)</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">The WILL/WONT/DO/DONT data is best saved in a mapping looking</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">like this:</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">~~~{.c}</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">([</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">  &quot;received&quot;: ([ option1: DO_DONT_OR_0;WILL_WONT_OR_0, ... ]),</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">  &quot;sent&quot;    : ([ option1: DO_DONT_OR_0;WILL_WONT_OR_0, ... ])</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">])</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">~~~</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">(Ok, it can be done better. But not without confusing &lt;em&gt;me&lt;/em&gt; more.)</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">Before sending anything check</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">TN[&quot;sent&quot;][option,0_if_do_dont_or_1_if_will_wont]</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">so you don&#39;t enter endless loops, save network traffic and the like.</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">The windowsize is best saved in the players environment variables so that he can modify them later on. (Or in two integers in the player object...). Use for these values is clear I think.</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">The terminaltypes received using above mentioned method are best stored in an array. The actual set terminaltype is best stored in an environment variable where the player can modify it. Upon modifying it the IAC SB TTYPE SEND IAC SE cycle should be started to match the emulation to the entered new terminaltype. You then may use data retrieved from /etc/termcap (man 5 termcap) or /usr/lib/terminfo/&lt;em&gt;/&lt;/em&gt; (SysVID, man 5 terminfo) to implement terminalcontrol codes dependend on the terminaltype. /etc/termcap may prove to be the easiest way tough /usr/lib/terminfo/&lt;em&gt;/&lt;/em&gt; is the newer (and better) SysV way of doing it.</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">LINEMODE replies may be left alone if only using the mode change to MODE_EDIT</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">Some statistics about what clients support telnet negotiations:</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">Tinyfugue and some other mudclients usually do not support negotiations.</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">Except for TF, which supports the Telnet End-Of-Record option as marker for the end of the prompt. So if you send IAC EOR after every prompt, it will print the prompt always in the input window. (Do not forget to negotiate that. First IAC WILL TELOPT_EOR/wait for IAC DO TELOPT_EOR). Newer versions of TF will support NAWS and there will be a patch for TTYPE negotiation available soon.</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment">All telnets able to do negotiations I&#39;ve encountered support the TTYPE option.</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">HP9.x,Irix5.x,Linux,EP/IX,CUTELNET/NCSATELNET (Novell) and perhaps more support NAWS.</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">At least Irix5.x,Linux,CU/NCSATELNET support LINEMODE.</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">SUN does not support NAWS and LINEMODE neither in SunOS 4.1.3 nor in Solaris 2.3.</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">For getting RFCs you can for example use @subpage driver_ftp:__ftp.uni-erlangen.de_pub_doc_rfc_ &quot;ftp://ftp.uni-erlangen.de/pub/doc/rfc/&quot;</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">@par misleading:Not all aspects of the options are mentioned to keep this doc at a reasonable size. Refer to the RFCs to get more confused.</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">CREDITS:</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">~~~{.c}</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">Provided by Marcus@TAPPMud (Marcus Meissner, &lt;msmeissn@cip.informatik.uni-erlangen.de&gt;).</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">~~~</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>negotiation.md</b></li>
    <li class="footer">Generated on Sat Jun 11 2016 14:24:07 for Tsunami by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
