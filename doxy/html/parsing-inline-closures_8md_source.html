<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Tsunami: internals/parsing-inline-closures.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tsunami
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('parsing-inline-closures_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">internals/parsing-inline-closures.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;parsing-<span class="keyword">inline</span>-closures {#driver_internals_parsing-<span class="keyword">inline</span>-closures}</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;===================================================================</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;This <span class="keywordtype">short</span> document tries to outline how scopes and variables are handled when parsing <span class="keyword">inline</span> closures.</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Let<span class="stringliteral">&#39;s take the following closure as an example:</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="stringliteral">~~~{.c}</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="stringliteral">int var;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="stringliteral">function void(string arg) : int ctx = 42</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="stringliteral">{</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="stringliteral">    int i = 2;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="stringliteral">    ctx += var - i;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="stringliteral">};</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="stringliteral">~~~</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="stringliteral">This closure might be a part of a code block, an initializer of a global variable or an initializer of a context variable of another closure.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="stringliteral">The example above has 4 block scopes in this order:</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="stringliteral">1. The outer block scope with &#39;</span>var<span class="stringliteral">&#39;.</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="stringliteral">2. The context scope with &#39;</span>ctx<span class="stringliteral">&#39;.</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="stringliteral">3. The argument scope with &#39;</span>arg<span class="stringliteral">&#39;.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="stringliteral">4. The inner block scope with &#39;</span>i<span class="stringliteral">&#39;.</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="stringliteral">   </span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="stringliteral">In each scope there may be three kinds of local variables (each one of them has .type = I_TYPE_LOCAL):</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="stringliteral">- real local ones:            .u.local.context &lt; 0</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="stringliteral">- explicit context variables: .u.local.context &gt;= 0 and .u.local.num &lt; 0</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="stringliteral">- implicit context variables: .u.local.context &gt;= 0 and .u.local.num &gt;= 0</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="stringliteral">Each local variable will have an index on the stack relative to the stack frame of the function or inline closure, and each context variable will have an index into the closure&#39;</span>s context. So the variable counters will be reset in block 2 (context scope), because then the closure (with it<span class="stringliteral">&#39;s own stack frame) will start. The block 2 (context) is first compiled as a part of the outer function and will then be transferred to the closure.</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="stringliteral">The above example will introduce the following variables:</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="stringliteral">Outer function:</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="stringliteral">   - &#39;</span>var<span class="stringliteral">&#39;: A local variable in scope 1, index 0</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="stringliteral">   - &#39;</span>ctx<span class="stringliteral">&#39;: A local variable in scope 2, index 1</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="stringliteral">   </span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="stringliteral">Inline closure:</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="stringliteral">   - &#39;</span>arg<span class="stringliteral">&#39;: A local variable in scope 3, index 0</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="stringliteral">   - &#39;</span>i<span class="stringliteral">&#39;:   A local variable in scope 4, index 1</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="stringliteral">   - &#39;</span>ctx<span class="stringliteral">&#39;: An explicit context variable in scope 2, context index 0</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="stringliteral">   - &#39;</span>var<span class="stringliteral">&#39;: An implicit context variable in scope 2, context index 1, variable index 1.</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="stringliteral">   </span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="stringliteral">The inline closure is parsed in 4 steps:</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="stringliteral">1. After `function void` the inline closure information structure (inline_closure_t) is initialized. For each inline closure that was parsed within a normal function such a structure is put into the A_INLINE_CLOSURE memory area. When the normal function is finished, the program code of all these closures will be copied from these structures into the real program&#39;</span>s code block.</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;   Also, the context scope and the argument scope are initialized. The argument scope is the inner scope, because they are parsed next. The variable counter (current_number_of_locals) is reset to 0 (but the old value is saved in the scope structure).</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;   </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;2. Then (<span class="keywordtype">string</span> arg) will be parsed, the same as <span class="keywordflow">for</span> normal functions. The variable names will be put into the innermost scope as local names.</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;3. The context `: <span class="keywordtype">int</span> ctx = 42` will be parsed. The context arguments will be parsed as <span class="keywordflow">if</span> they would belong to the outer scope. In fact, the compiler will issue bytecode to initialize them as local variables of the outer <span class="keyword">function</span> and store their values there. The F_CONTEXT_CLOSURE bytecode will later copy these variables from <span class="keyword">this</span> <span class="keyword">function</span> into the closure as its context.</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;   In order <span class="keywordflow">for</span> <span class="keyword">this</span> to happen, scope 2 is initialized as it would belong to the outer <span class="keyword">function</span> (its variable counter `first_local` is set to the counter of scope 1). Scope 3 will be ignored and marked inaccessible so that references to argument names are caught as errors. Then the context is parsed and the variables are not put into the topmost scope 3, but the one underneath it (scope 2).</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;   </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;   In the end, each variable in scope 2 is given a context index and stripped of its variable index, so that they become <span class="keyword">explicit</span> context variables.</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;   </div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;4. The block will be parsed. That<span class="stringliteral">&#39;s done just like a normal function except that, wherever a local variable is used, the compiler calls check_for_context_local to see whether this variable belongs to an outer scope (block depth of the variable is below the initial block depth of the inline closure). If that is the case the compiler introduces a new context variable with the same name but in the context scope 2 of the inline variable. The index of the original variable is recorded in the .u.local.num field (it the original variable is also a context variable, CONTEXT_VARIABLE_BASE is added to its context index).</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="stringliteral">   After the block has been compiled, its bytecode will be moved into the A_INLINE_CLOSURE memory block (together with the line-number information). It will be copied back after the current function has been completed. Also, a bytecode is issued for each implicit variable to put the value from the original variable on the stack. These values will serve as arguments for the final F_CONTEXT_CLOSURE bytecode.</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="stringliteral">   </span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>parsing-inline-closures.md</b></li>
    <li class="footer">Generated on Tue Jun 7 2016 19:15:58 for Tsunami by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
