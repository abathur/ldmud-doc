<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mysql &mdash; LDMud UNRELEASED documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'UNRELEASED',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="LDMud UNRELEASED documentation" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="mysql">
<div class="section" id="SYNOPSIS">
<h2>SYNOPSIS<a class="headerlink" href="#SYNOPSIS" title="Permalink to this headline">¶</a></h2>
<p id="lpc.mysql">mysql</p>
</div>
<div class="section" id="DESCRIPTION">
<h2>DESCRIPTION<a class="headerlink" href="#DESCRIPTION" title="Permalink to this headline">¶</a></h2>
<p>On hosts with the mySQL package installed, the driver can be
configured to interface with the mySQL database. If that is done,
the driver defines the macro __MYSQL__ for LPC programs and
activates a number of efuns.</p>
<div class="section" id="Configuration">
<span id="lpc.Configuration"></span><h3>CONFIGURATION<a class="headerlink" href="#Configuration" title="Permalink to this headline">¶</a></h3>
<p>Create a dedicated user in the mySQL database for the driver.
Enter this username and password in the file pkg-mysql.c, function
mysql_real_connect(), and compile the driver (the username and
password are built into the driver for security reasons). If you
choose to not create either a username and/or a password, leave the
corresponding entry at 0.</p>
<p>Use mysqladmin to create any databases you want to provide - the
names are later used in the efun db_connect() to connect to
the databases.</p>
</div>
<div class="section" id="Usage">
<span id="lpc.Usage"></span><h3>USAGE<a class="headerlink" href="#Usage" title="Permalink to this headline">¶</a></h3>
<p>The idea behind SQL-support is that you can swap large amounts of
data into a database where it can be accessed very easily.
As mySQL &#8220;limits&#8221; the number of connections to 100 and as every
connection to the mySQL-server takes time, you should use
database serverobjects in your MUD which constantly keep the
connection to the mySQL-server.</p>
<p>To connect to your mySQL-server, use the efun db_connect(). It
takes only one argument which is the name of the database (which
must exist). The return-value of db_connect() is an integer
representing the unique handle to the database with which you will
identify your connection later.</p>
<p>To send or retrieve data from this connection, use db_exec(). The
first parameter for all efuns dealing with an open connection is
always the handle and so is the first argument the handle and the
second one the command you want to issue. The return-value is
either 0 if there was an error in your command (this can have
various reasons), otherwise your handle is returned again. A typical
SQL-statement to retrieve data would be like this:</p>
<blockquote>
<div><dl class="docutils">
<dt>select aliases.command from aliases where (name = &#8216;mario&#8217; AND</dt>
<dd>alias regexp &#8216;l.*&#8217;)</dd>
</dl>
</div></blockquote>
<p>As you know, mySQL accepts either &#8221; or &#8216; to classify strings for
parameters.  Most likely, you will pass variables and don&#8217;t know
whether they contain one or more of these key-chars (or even other
chars that need to be converted). mySQL provides a function for
converting just any string into an acceptable argument and this is
implemented in db_conv_string().</p>
<p>So the above example with variables looks like this:</p>
<blockquote>
<div><dl class="docutils">
<dt>select aliases.command from aliases where (name =&#8217;&#8221;+</dt>
<dd>db_conv_string(name)+&#8221;&#8217; AND alias regexp &#8216;&#8221;+
db_conv_string(mask)+&#8221;&#8217;)</dd>
</dl>
</div></blockquote>
<p>I left out the db_exec()-stuff, more complete examples will follow.</p>
<p>After you initiated a statement that should return rows from the
database, use db_fetch() to retrieve the data. db_fetch() returns
the data row by row and not all at once. You need to call it until
it returns 0. THIS IS IMPORTANT! If stop calling db_fetch() before
it reaches the end of data, serious inconsistencies can happen.</p>
<p>If you used a DELETE- or UPDATE-statement, you cannot call db_fetch(),
but you might be interested in the number of deleted/changed rows
which can be queried with db_affected_rows().</p>
<p>After all operations are done in the database, you should use
db_close() to close the connection again. If you are using a
database-server-concept, place it in the remove()-function.</p>
<p>The SQL-efuns have some built-in optimization-features to speed up
often used connections. To get a list of all open connections to the
mySQL-server, use db_handles() which returns an array of integers
with all open handles.</p>
</div>
<div class="section" id="Security">
<span id="lpc.Security"></span><h3>SECURITY<a class="headerlink" href="#Security" title="Permalink to this headline">¶</a></h3>
<p>Most SQL efuns (unless execute by the master or the simul-efun object)
trigger a privilege_violation (&#8220;mysql&#8221;, &#8220;&lt;efun_name&gt;&#8221;). If a more
finegrained control is desired, overload the individual efuns with a
nomask simul-efun.</p>
<p>The unprivileged efuns are:</p>
<blockquote>
<div>db_conv_string()</div></blockquote>
</div>
<div class="section" id="Caveats">
<span id="lpc.Caveats"></span><h3>CAVEATS<a class="headerlink" href="#Caveats" title="Permalink to this headline">¶</a></h3>
<p>The driver enables automatic reconnects on the database connections.
This means that if a connection is lost - the most common case for
this is timeouts, which by default happen after 28800 seconds of
inactivity - an attempt will be made to establish a new connection to
the database server. When that happens, all session state (temprary
tables and state changes from SET statements) will be lost. It&#8217;s best
not to rely on such state.</p>
</div>
<div class="section" id="Example">
<span id="lpc.Example"></span><h3>EXAMPLE<a class="headerlink" href="#Example" title="Permalink to this headline">¶</a></h3>
<p>A simple server to store aliases could be implemented like this:</p>
<p>/*
**  CREATION:
**
**  create table aliases (
**      name varchar(15) not NULL,
**      alias varchar(20) not NULL,
**      command varchar(255) not NULL,
**      primary key (name, alias));
<a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
<p>#define DATABASE &#8220;mud&#8221;</p>
<p>private int handle;</p>
<p>public void create()
{</p>
<blockquote>
<div>handle = db_connect(DATABASE);</div></blockquote>
<p>}</p>
<p>public int remove()
{</p>
<blockquote>
<div><dl class="docutils">
<dt>if ( handle )</dt>
<dd>db_close(handle);</dd>
</dl>
<p>destruct(ME);
return !ME;</p>
</div></blockquote>
<p>}</p>
<p>public int AddAlias(string alias, string command, object ob)
{</p>
<blockquote>
<div><dl class="docutils">
<dt>if ( !handle )</dt>
<dd>handle = db_connect(DATABASE);</dd>
<dt>if ( !db_exec(handle,</dt>
<dd><blockquote class="first">
<div><p>&#8220;insert into aliases (name, alias, command) values &#8221;
&#8220;(&#8216;&#8221; + getuid(ob) + &#8220;&#8217;,&#8217;&#8221; + db_conv_string(alias)</p>
<blockquote>
<div><ul class="simple">
<li>&#8220;&#8217;,&#8217;&#8221;+</li>
</ul>
</div></blockquote>
<p>db_conv_string(command) + &#8220;&#8217;)&#8221;) )</p>
</div></blockquote>
<p class="last">return -1;</p>
</dd>
</dl>
<p>return 1;</p>
</div></blockquote>
<p>}</p>
<p>public int RemoveAlias(string alias, object ob)
{</p>
<blockquote>
<div><p>int res;</p>
<dl class="docutils">
<dt>if ( !handle )</dt>
<dd>handle = db_connect(DATABASE);</dd>
<dt>res = db_exec(handle,</dt>
<dd><p class="first">&#8220;delete from aliases where (name = &#8216;&#8221;+
getuid(ob) + &#8220;&#8217; AND alias = &#8216;&#8221;</p>
<blockquote>
<div><ul class="simple">
<li>db_conv_string(alias)+</li>
</ul>
</div></blockquote>
<p class="last">&#8220;&#8217;)&#8221;);</p>
</dd>
<dt>if ( !res )</dt>
<dd>return 0;</dd>
</dl>
<p>res = db_affected_rows(handle);
return (res &gt; 0)?1:-1;</p>
</div></blockquote>
<p>}</p>
<p>public mixed <a href="#id3"><span class="problematic" id="id4">*</span></a>QueryAliases(string mask, object ob)
{</p>
<blockquote>
<div><p>mixed <a href="#id5"><span class="problematic" id="id6">*</span></a>result;
string <a href="#id7"><span class="problematic" id="id8">*</span></a>tmp;</p>
<dl class="docutils">
<dt>if ( !handle )</dt>
<dd>handle = db_connect(DATABASE);</dd>
<dt>if ( !db_exec(handle,</dt>
<dd><blockquote class="first">
<div>&#8220;select aliases.alias, aliases.command from aliases where &#8221;
&#8220;(name = &#8216;&#8221; + getuid(ob)+
&#8220;&#8217; AND alias regexp &#8216;&#8221; + db_conv_string(mask) + &#8220;&#8217;)&#8221;) )</div></blockquote>
<p class="last">return ({ });</p>
</dd>
</dl>
<p>result = ({ });
while ( sizeof(tmp = db_fetch(handle)) )</p>
<blockquote>
<div>result += ({ tmp });</div></blockquote>
<p>return result;</p>
</div></blockquote>
<p>}</p>
<p>public string QueryAlias(string alias, object ob)
{</p>
<blockquote>
<div><p>mixed <a href="#id9"><span class="problematic" id="id10">*</span></a>result;
string <a href="#id11"><span class="problematic" id="id12">*</span></a>tmp;</p>
<dl class="docutils">
<dt>if ( !handle )</dt>
<dd>handle = db_connect(DATABASE);</dd>
<dt>if ( !db_exec(handle,</dt>
<dd><blockquote class="first">
<div>&#8220;select aliases.command from aliases where &#8221;
&#8220;(name = &#8216;&#8221; + getuid(ob)+
&#8220;&#8217; AND alias = &#8216;&#8221; + db_conv_string(alias) + &#8220;&#8217;)&#8221;) )</div></blockquote>
<p class="last">return 0;</p>
</dd>
</dl>
<p>result = ({ });
while ( sizeof(tmp = db_fetch(handle)) )</p>
<blockquote>
<div>result += tmp;</div></blockquote>
<p>return sizeof(result)?result[0]:0;</p>
</div></blockquote>
<p>}</p>
</div>
<div class="section" id="AUTHOR Mark Daniel Reidel and others.">
<span id="lpc.AUTHOR
Mark Daniel Reidel and others."></span><h3>AUTHOR
MARK DANIEL REIDEL AND OTHERS.<a class="headerlink" href="#AUTHOR
Mark Daniel Reidel and others." title="Permalink to this headline">¶</a></h3>
</div>
<h2 id="HISTORY">HISTORY<a class="headerlink" href="#DESCRIPTION" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>introduced</strong> (<em>3.2.8</em>) &#8211; as package</li>
<li><strong>changed</strong> (<em>3.2.9</em>) &#8211; integrated with driver</li>
<li><strong>changed</strong> (<em>3.2.11</em>) &#8211; added a privilege_violation() call for each efun</li>
</ul>
<h2 id="see2also">SEE ALSO<a class="headerlink" href="#DESCRIPTION" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="pgsql.html#lpc.pgsql" title="pgsql"><span class="xref lpc lpc-concept">pgsql</span></a>, <a class="reference internal" href="../efun/db_affected_rows.html#lpc.db_affected_rows" title="db_affected_rows"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_affected_rows</span></code>(E)</a>, <a class="reference internal" href="../efun/db_conv_string.html#lpc.db_conv_string" title="db_conv_string"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_conv_string</span></code>(E)</a>, <a class="reference internal" href="../efun/db_close.html#lpc.db_close" title="db_close"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_close</span></code>(E)</a>, <a class="reference internal" href="../efun/db_connect.html#lpc.db_connect" title="db_connect"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_connect</span></code>(E)</a>, <a class="reference internal" href="../efun/db_exec.html#lpc.db_exec" title="db_exec"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_exec</span></code>(E)</a>, <a class="reference internal" href="../efun/db_fetch.html#lpc.db_fetch" title="db_fetch"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_fetch</span></code>(E)</a>, <a class="reference internal" href="../efun/db_handles.html#lpc.db_handles" title="db_handles"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_handles</span></code>(E)</a>, <a class="reference internal" href="../efun/db_insert_id.html#lpc.db_insert_id" title="db_insert_id"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_insert_id</span></code>(E)</a>, <a class="reference internal" href="../efun/db_coldefs.html#lpc.db_coldefs" title="db_coldefs"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_coldefs</span></code>(E)</a>, <a class="reference internal" href="../efun/db_error.html#lpc.db_error" title="db_error"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_error</span></code>(E)</a>, <a class="reference internal" href="../master/privilege_violation.html#lpc.privilege_violation" title="privilege_violation"><code class="xref lpc lpc-applied docutils literal"><span class="pre">privilege_violation</span></code>(M)</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">mysql</a><ul>
<li><a class="reference internal" href="#SYNOPSIS">SYNOPSIS</a></li>
<li><a class="reference internal" href="#DESCRIPTION">DESCRIPTION</a><ul>
<li><a class="reference internal" href="#Configuration">CONFIGURATION</a></li>
<li><a class="reference internal" href="#Usage">USAGE</a></li>
<li><a class="reference internal" href="#Security">SECURITY</a></li>
<li><a class="reference internal" href="#Caveats">CAVEATS</a></li>
<li><a class="reference internal" href="#Example">EXAMPLE</a></li>
<li><a class="reference internal" href="#AUTHOR Mark Daniel Reidel and others.">AUTHOR
MARK DANIEL REIDEL AND OTHERS.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hook/hook.html">hooks</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;good question.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
      |
      <a href="../_sources/concepts/mysql.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>