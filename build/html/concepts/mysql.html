<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mysql &mdash; LDMud UNRELEASED documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'UNRELEASED',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="LDMud UNRELEASED documentation" href="../index.html" />
    <link rel="up" title="concepts" href="concepts.html" />
    <link rel="next" title="native" href="native.html" />
    <link rel="prev" title="memory" href="memory.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="mysql">
<span id="lpc.mysql"></span><div class="section" id="CONCEPT">
<h2>CONCEPT<a class="headerlink" href="#CONCEPT" title="Permalink to this headline">¶</a></h2>
<p>mysql</p>
</div>
<div class="section" id="DESCRIPTION">
<h2>DESCRIPTION<a class="headerlink" href="#DESCRIPTION" title="Permalink to this headline">¶</a></h2>
<p>On hosts with the mySQL package installed, the driver can be configured to interface with the mySQL database. If that is done, the driver defines the macro __MYSQL__ for LPC programs and activates a number of efuns.</p>
<div class="section" id="glossary">
<h3>CONFIGURATION<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h3>
<p>Create a dedicated user in the mySQL database for the driver. Enter this username and password in the file pkg-mysql.c, function mysql_real_connect(), and compile the driver (the username and password are built into the driver for security reasons). If you choose to not create either a username and/or a password, leave the corresponding entry at 0.</p>
<p>Use mysqladmin to create any databases you want to provide - the names are later used in the efun db_connect() to connect to the databases.</p>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">reconcile how this doc uses usage/example sections</p>
</div>
<div class="section" id="glossary">
<h3>USAGE<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h3>
<p>The idea behind SQL-support is that you can swap large amounts of data into a database where it can be accessed very easily. As mySQL &#8220;limits&#8221; the number of connections to 100 and as every connection to the mySQL-server takes time, you should use database serverobjects in your MUD which constantly keep the connection to the mySQL-server.</p>
<p>To connect to your mySQL-server, use the efun db_connect(). It takes only one argument which is the name of the database (which must exist). The return-value of db_connect() is an integer representing the unique handle to the database with which you will identify your connection later.</p>
<p>To send or retrieve data from this connection, use db_exec(). The first parameter for all efuns dealing with an open connection is always the handle and so is the first argument the handle and the second one the command you want to issue. The return-value is either 0 if there was an error in your command (this can have various reasons), otherwise your handle is returned again. A typical SQL-statement to retrieve data would be like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span>select aliases.command from aliases where (name = &#39;mario&#39; AND
  alias regexp &#39;l.*&#39;)
</pre></div>
</div>
<p>As you know, mySQL accepts either &#8221; or &#8216; to classify strings for parameters. Most likely, you will pass variables and don&#8217;t know whether they contain one or more of these key-chars (or even other chars that need to be converted). mySQL provides a function for converting just any string into an acceptable argument and this is implemented in db_conv_string().</p>
<p>So the above example with variables looks like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span>select aliases.command from aliases where (name =&#39;&quot;+
  db_conv_string(name)+&quot;&#39; AND alias regexp &#39;&quot;+
  db_conv_string(mask)+&quot;&#39;)
</pre></div>
</div>
<p>I left out the db_exec()-stuff, more complete examples will follow.</p>
<p>After you initiated a statement that should return rows from the database, use db_fetch() to retrieve the data. db_fetch() returns the data row by row and not all at once. You need to call it until it returns 0. THIS IS IMPORTANT! If stop calling db_fetch() before it reaches the end of data, serious inconsistencies can happen.</p>
<p>If you used a DELETE- or UPDATE-statement, you cannot call db_fetch(), but you might be interested in the number of deleted/changed rows which can be queried with db_affected_rows().</p>
<p>After all operations are done in the database, you should use db_close() to close the connection again. If you are using a database-server-concept, place it in the remove()-function.</p>
<p>The SQL-efuns have some built-in optimization-features to speed up often used connections. To get a list of all open connections to the mySQL-server, use db_handles() which returns an array of integers with all open handles.</p>
</div>
<div class="section" id="glossary">
<h3>SECURITY<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h3>
<p>Most SQL efuns (unless execute by the master or the simul-efun object) trigger a privilege_violation (&#8220;mysql&#8221;, &#8220;&lt;efun_name&gt;&#8221;). If a more finegrained control is desired, overload the individual efuns with a nomask simul-efun.</p>
<p>The unprivileged efuns are:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../efun/db_conv_string.html#lpc.db_conv_string" title="db_conv_string"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_conv_string()</span></code>(E)</a></li>
</ul>
</div></blockquote>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The driver enables automatic reconnects on the database connections. This means that if a connection is lost&#8211;the most common case for this is timeouts, which by default happen after 28800 seconds of inactivity&#8211;an attempt will be made to establish a new connection to the database server. When that happens, all session state (temprary tables and state changes from SET statements) will be lost. It&#8217;s best not to rely on such state.</p>
</div>
<div class="section" id="glossary">
<h3>EXAMPLE<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h3>
<p>A simple server to store aliases could be implemented like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">**  CREATION:</span>
<span class="cm">**</span>
<span class="cm">**  create table aliases (</span>
<span class="cm">**      name varchar(15) not NULL,</span>
<span class="cm">**      alias varchar(20) not NULL,</span>
<span class="cm">**      command varchar(255) not NULL,</span>
<span class="cm">**      primary key (name, alias));</span>
<span class="cm">*/</span>

<span class="cp">#define DATABASE &quot;mud&quot;</span>

<span class="n">private</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">;</span>

<span class="n">public</span> <span class="kt">void</span> <span class="nf">create</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">handle</span> <span class="o">=</span> <span class="n">db_connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">public</span> <span class="kt">int</span> <span class="nf">remove</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">handle</span> <span class="p">)</span>
    <span class="n">db_close</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
  <span class="n">destruct</span><span class="p">(</span><span class="n">ME</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">!</span><span class="n">ME</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">public</span> <span class="kt">int</span> <span class="nf">AddAlias</span><span class="p">(</span><span class="n">string</span> <span class="n">alias</span><span class="p">,</span> <span class="n">string</span> <span class="n">command</span><span class="p">,</span> <span class="n">object</span> <span class="n">ob</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">handle</span> <span class="p">)</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">db_connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">db_exec</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;insert into aliases (name, alias, command) values (&#39;&quot;</span> <span class="o">+</span> <span class="n">getuid</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">db_conv_string</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span><span class="n">db_conv_string</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">public</span> <span class="kt">int</span> <span class="nf">RemoveAlias</span><span class="p">(</span><span class="n">string</span> <span class="n">alias</span><span class="p">,</span> <span class="n">object</span> <span class="n">ob</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">handle</span> <span class="p">)</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">db_connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">);</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">db_exec</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
    <span class="s">&quot;delete from aliases where (name = &#39;&quot;</span><span class="o">+</span> <span class="n">getuid</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39; AND alias = &#39;&quot;</span> <span class="o">+</span> <span class="n">db_conv_string</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">res</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">db_affected_rows</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">mixed</span> <span class="o">*</span><span class="nf">QueryAliases</span><span class="p">(</span><span class="n">string</span> <span class="n">mask</span><span class="p">,</span> <span class="n">object</span> <span class="n">ob</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">mixed</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
  <span class="n">string</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">handle</span> <span class="p">)</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">db_connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">db_exec</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;select aliases.alias, aliases.command from aliases where (name = &#39;&quot;</span> <span class="o">+</span> <span class="n">getuid</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39; AND alias regexp &#39;&quot;</span> <span class="o">+</span> <span class="n">db_conv_string</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">({</span> <span class="p">});</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">({</span> <span class="p">});</span>
  <span class="k">while</span> <span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">db_fetch</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="p">({</span> <span class="n">tmp</span> <span class="p">});</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">string</span> <span class="nf">QueryAlias</span><span class="p">(</span><span class="n">string</span> <span class="n">alias</span><span class="p">,</span> <span class="n">object</span> <span class="n">ob</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">mixed</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
  <span class="n">string</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">handle</span> <span class="p">)</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">db_connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">db_exec</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;select aliases.command from aliases where (name = &#39;&quot;</span> <span class="o">+</span> <span class="n">getuid</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot;&#39; AND alias = &#39;&quot;</span> <span class="o">+</span> <span class="n">db_conv_string</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">({</span> <span class="p">});</span>
  <span class="k">while</span> <span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">db_fetch</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">?</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="LORE">
<h2>LORE<a class="headerlink" href="#LORE" title="Permalink to this headline">¶</a></h2>
<p>AUTHOR:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">Mark</span> <span class="n">Daniel</span> <span class="n">Reidel</span> <span class="n">and</span> <span class="n">others</span><span class="p">.</span>
</pre></div>
</div>
</div>
<div class="section" id="HISTORY">
<h2>HISTORY<a class="headerlink" href="#HISTORY" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>introduced</strong> (<em>3.2.8</em>) &#8211; as package</li>
<li><strong>changed</strong> (<em>3.2.9</em>) &#8211; integrated with driver</li>
<li><strong>changed</strong> (<em>3.2.11</em>) &#8211; added a privilege_violation() call for each efun</li>
</ul>
</div>
<div class="section" id="see2also">
<h2>SEE ALSO<a class="headerlink" href="#see2also" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="pgsql.html#lpc.pgsql" title="pgsql"><code class="xref lpc lpc-concept docutils literal"><span class="pre">pgsql</span></code>(C)</a>, <a class="reference internal" href="../efun/db_affected_rows.html#lpc.db_affected_rows" title="db_affected_rows"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_affected_rows()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_conv_string.html#lpc.db_conv_string" title="db_conv_string"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_conv_string()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_close.html#lpc.db_close" title="db_close"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_close()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_connect.html#lpc.db_connect" title="db_connect"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_connect()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_exec.html#lpc.db_exec" title="db_exec"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_exec()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_fetch.html#lpc.db_fetch" title="db_fetch"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_fetch()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_handles.html#lpc.db_handles" title="db_handles"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_handles()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_insert_id.html#lpc.db_insert_id" title="db_insert_id"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_insert_id()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_coldefs.html#lpc.db_coldefs" title="db_coldefs"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_coldefs()</span></code>(E)</a>, <a class="reference internal" href="../efun/db_error.html#lpc.db_error" title="db_error"><code class="xref lpc lpc-efun docutils literal"><span class="pre">db_error()</span></code>(E)</a>, <code class="xref lpc lpc-applied docutils literal"><span class="pre">privilege_violation</span></code></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">mysql</a><ul>
<li><a class="reference internal" href="#CONCEPT">CONCEPT</a></li>
<li><a class="reference internal" href="#DESCRIPTION">DESCRIPTION</a><ul>
<li><a class="reference internal" href="#glossary">CONFIGURATION</a></li>
<li><a class="reference internal" href="#glossary">USAGE</a></li>
<li><a class="reference internal" href="#glossary">SECURITY</a></li>
<li><a class="reference internal" href="#glossary">EXAMPLE</a></li>
<li><a class="reference internal" href="#LORE">LORE</a></li>
<li><a class="reference internal" href="#HISTORY">HISTORY</a></li>
<li><a class="reference internal" href="#see2also">SEE ALSO</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../applied/applied.html">applied</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="concepts.html">concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver/driver.html">driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../efun/efun.html">efun</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hook/hook.html">hook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals/internals.html">internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../master/master.html">master</a></li>
<li class="toctree-l1"><a class="reference internal" href="../obsolete/obsolete.html">obsolete</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LPC/lpc.html">LPC</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;good question.
      
      |
      <a href="../_sources/concepts/mysql.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>